<ion-header class="ion-no-border">
  <ion-toolbar>
    <ion-title>
      <div class="header-content">
        <div class="logo-container">
          <ion-icon name="briefcase-outline"></ion-icon>
        </div>
        <div class="title-wrapper">
          <h1 class="main-title">Task Manager</h1>
          <p class="subtitle">Organize your day efficiently</p>
        </div>
      </div>
    </ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <div class="content-container">
    <!-- Stats Cards -->
    <div class="stats-grid">
      <div class="stat-card stat-total">
        <div class="stat-icon-wrapper">
          <ion-icon name="list-outline"></ion-icon>
        </div>
        <div class="stat-info">
          <span class="stat-value">{{ filteredTasks().length }}</span>
          <span class="stat-label">Total Tasks</span>
        </div>
      </div>

      <div class="stat-card stat-pending">
        <div class="stat-icon-wrapper">
          <ion-icon name="time-outline"></ion-icon>
        </div>
        <div class="stat-info">
          <span class="stat-value">{{ pendingCount() }}</span>
          <span class="stat-label">Pending</span>
        </div>
      </div>

      <div class="stat-card stat-completed">
        <div class="stat-icon-wrapper">
          <ion-icon name="checkmark-circle-outline"></ion-icon>
        </div>
        <div class="stat-info">
          <span class="stat-value">{{ completedCount() }}</span>
          <span class="stat-label">Completed</span>
        </div>
      </div>
    </div>

    <!-- Category Management Section -->
    <div class="category-management-section">
      <div class="section-header-with-action">
        <h2 class="section-title">
          <ion-icon name="pricetag-outline"></ion-icon>
          Categories
        </h2>
        <ion-button
          fill="solid"
          size="small"
          (click)="openCategoryModal()"
          class="create-category-btn"
        >
          <ion-icon slot="start" name="add-outline"></ion-icon>
          New Category
        </ion-button>
      </div>

      <div class="categories-management-grid">
        @for (category of categories(); track category.id) {
        <div class="category-card" [style.--category-color]="category.color">
          <div class="category-info">
            <div class="category-icon-wrapper">
              <ion-icon name="pricetag-outline"></ion-icon>
            </div>
            <div class="category-details">
              <h4 class="category-name">{{ category.name }}</h4>
              <p class="category-task-count">
                {{ getTaskCountByCategory(category.id) }} task{{
                  getTaskCountByCategory(category.id) !== 1 ? 's' : ''
                }}
              </p>
            </div>
          </div>
          <div class="category-actions">
            <ion-button
              fill="clear"
              size="small"
              (click)="filterByCategory(category.id)"
              class="category-action-btn"
            >
              <ion-icon slot="icon-only" name="funnel-outline"></ion-icon>
            </ion-button>
            <ion-button
              fill="clear"
              size="small"
              color="danger"
              (click)="confirmDeleteCategory(category.id)"
              class="category-action-btn delete-btn"
            >
              <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
            </ion-button>
          </div>
        </div>
        }
      </div>
    </div>

    <!-- Category Filter -->
    <div class="filter-section">
      <div class="filter-header">
        <h2 class="section-title">
          <ion-icon name="funnel-outline"></ion-icon>
          Active Filter
        </h2>
        @if (selectedCategoryFilter()) {
        <ion-button fill="clear" size="small" (click)="clearFilter()" class="clear-filter-btn">
          <ion-icon slot="start" name="close-outline"></ion-icon>
          Clear Filter
        </ion-button>
        }
      </div>

      <div class="categories-chips">
        <ion-chip
          [class.active]="!selectedCategoryFilter()"
          (click)="clearFilter()"
          class="filter-chip all-chip"
        >
          <ion-icon name="list-outline"></ion-icon>
          <ion-label>All Tasks</ion-label>
        </ion-chip>

        @for (category of categories(); track category.id) {
        <ion-chip
          [class.active]="isFilterActive(category.id)"
          (click)="filterByCategory(category.id)"
          class="filter-chip"
          [style.--chip-color]="category.color"
        >
          <ion-icon name="pricetag-outline"></ion-icon>
          <ion-label>{{ category.name }}</ion-label>
        </ion-chip>
        }
      </div>
    </div>

    <!-- Quick Add Task -->
    <div class="quick-add-section">
      <h2 class="section-title">
        <ion-icon name="add-circle-outline"></ion-icon>
        Quick Add
      </h2>

      <div class="quick-add-card">
        <div class="input-group">
          <div class="input-wrapper">
            <ion-icon name="create-outline" class="input-icon"></ion-icon>
            <ion-input
              type="text"
              placeholder="What needs to be done?"
              [formControl]="taskControl"
              (keyup.enter)="submit()"
              class="task-input"
            ></ion-input>
          </div>

          <div class="category-selector">
            <ion-icon name="pricetag-outline" class="input-icon"></ion-icon>
            <ion-select
              interface="action-sheet"
              placeholder="Category"
              [formControl]="categoryControl"
              class="category-select"
            >
              @for (category of categories(); track category.id) {
              <ion-select-option [value]="category.id">
                {{ category.name }}
              </ion-select-option>
              }
            </ion-select>
          </div>
        </div>

        <ion-button
          expand="block"
          (click)="submit()"
          [disabled]="taskControl.invalid"
          class="add-task-button"
        >
          <ion-icon slot="start" name="add-outline"></ion-icon>
          Add Task
        </ion-button>
      </div>
    </div>

    <!-- Tasks Display -->
    <div class="tasks-container">
      @if (filteredTasks().length === 0) {
      <div class="empty-state">
        <div class="empty-illustration">
          <ion-icon name="checkmark-done-outline"></ion-icon>
        </div>
        @if (selectedCategoryFilter()) {
        <h3 class="empty-title">No tasks in this category</h3>
        <p class="empty-message">
          No tasks found for
          <strong>{{ getCategoryById(selectedCategoryFilter()!)?.name }}</strong>
        </p>
        <ion-button fill="outline" size="small" class="empty-action" (click)="clearFilter()">
          <ion-icon slot="start" name="close-outline"></ion-icon>
          Clear Filter
        </ion-button>
        } @else {
        <h3 class="empty-title">All Clear!</h3>
        <p class="empty-message">You have no tasks yet. Create your first task to get started.</p>
        <ion-button fill="outline" size="small" class="empty-action">
          <ion-icon slot="start" name="add-outline"></ion-icon>
          Create Task
        </ion-button>
        }
      </div>
      } @else {
      <!-- Pending Tasks Section -->
      @if (pendingTasks().length > 0) {
      <div class="tasks-section">
        <div class="section-header">
          <div class="section-title-wrapper">
            <div class="section-icon pending-icon">
              <ion-icon name="hourglass-outline"></ion-icon>
            </div>
            <div>
              <h3 class="section-title-main">In Progress</h3>
              <p class="section-subtitle">
                {{ pendingCount() }} task{{ pendingCount() !== 1 ? 's' : '' }} to complete
              </p>
            </div>
          </div>
        </div>

        <div class="tasks-grid">
          @for (task of pendingTasks(); track task.id) {
          <ion-item-sliding #slidingItem class="task-sliding">
            <ion-item-options side="end">
              <ion-item-option color="danger" (click)="deleteTask(task.id); slidingItem.close()">
                <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
              </ion-item-option>
            </ion-item-options>

            <ion-item lines="none" class="task-card pending-task">
              <div class="task-wrapper">
                <ion-checkbox
                  [checked]="task.completed"
                  (ionChange)="toggleTask(task.id)"
                  class="custom-checkbox"
                ></ion-checkbox>

                <div class="task-details">
                  <p class="task-title">{{ task.title }}</p>
                  <span
                    class="task-category-badge"
                    [style.background]="getCategoryById(task.categoryId)?.color"
                  >
                    {{ getCategoryById(task.categoryId)?.name }}
                  </span>
                </div>

                <ion-button
                  fill="clear"
                  size="small"
                  (click)="deleteTask(task.id)"
                  class="task-delete-btn"
                >
                  <ion-icon slot="icon-only" name="close-outline"></ion-icon>
                </ion-button>
              </div>
            </ion-item>
          </ion-item-sliding>
          }
        </div>
      </div>
      }

      <!-- Completed Tasks Section -->
      @if (completedTasks().length > 0) {
      <div class="tasks-section completed-section">
        <div class="section-header">
          <div class="section-title-wrapper">
            <div class="section-icon completed-icon">
              <ion-icon name="checkmark-done-outline"></ion-icon>
            </div>
            <div>
              <h3 class="section-title-main">Completed</h3>
              <p class="section-subtitle">
                {{ completedCount() }} task{{ completedCount() !== 1 ? 's' : '' }} done
              </p>
            </div>
          </div>

          <ion-button fill="clear" size="small" (click)="clearCompleted()" class="clear-all-btn">
            <ion-icon slot="start" name="trash-outline"></ion-icon>
            Clear All
          </ion-button>
        </div>

        <div class="tasks-grid">
          @for (task of completedTasks(); track task.id) {
          <ion-item-sliding #slidingItem class="task-sliding">
            <ion-item-options side="end">
              <ion-item-option color="danger" (click)="deleteTask(task.id); slidingItem.close()">
                <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
              </ion-item-option>
            </ion-item-options>

            <ion-item lines="none" class="task-card completed-task">
              <div class="task-wrapper">
                <ion-checkbox
                  [checked]="task.completed"
                  (ionChange)="toggleTask(task.id)"
                  class="custom-checkbox"
                ></ion-checkbox>

                <div class="task-details">
                  <p class="task-title completed-title">{{ task.title }}</p>
                  <span
                    class="task-category-badge"
                    [style.background]="getCategoryById(task.categoryId)?.color"
                  >
                    {{ getCategoryById(task.categoryId)?.name }}
                  </span>
                </div>

                <ion-button
                  fill="clear"
                  size="small"
                  (click)="deleteTask(task.id)"
                  class="task-delete-btn"
                >
                  <ion-icon slot="icon-only" name="close-outline"></ion-icon>
                </ion-button>
              </div>
            </ion-item>
          </ion-item-sliding>
          }
        </div>
      </div>
      } }
    </div>
  </div>
</ion-content>

<!-- Category Creation Modal -->
<ion-modal [isOpen]="isCategoryModalOpen()" (didDismiss)="closeCategoryModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Create New Category</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeCategoryModal()">
            <ion-icon slot="icon-only" name="close-outline"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="ion-padding">
      <div class="modal-content">
        <!-- Category Name Input -->
        <div class="form-field">
          <label class="field-label">
            <ion-icon name="create-outline"></ion-icon>
            Category Name
          </label>
          <div class="input-wrapper-modal">
            <ion-input
              type="text"
              placeholder="e.g., Work, Personal, Shopping"
              [formControl]="categoryNameControl"
              class="modal-input"
            ></ion-input>
          </div>
          @if (categoryNameControl.invalid && categoryNameControl.touched) {
          <p class="error-message">Category name must be at least 2 characters</p>
          }
        </div>

        <!-- Color Picker -->
        <div class="form-field">
          <label class="field-label">
            <ion-icon name="color-palette-outline"></ion-icon>
            Choose Color
          </label>
          <div class="color-picker-grid">
            @for (color of predefinedColors; track color) {
            <div
              class="color-option"
              [class.selected]="categoryColorControl.value === color"
              [style.background]="color"
              (click)="selectColor(color)"
            >
              @if (categoryColorControl.value === color) {
              <ion-icon name="checkmark-outline" class="check-icon"></ion-icon>
              }
            </div>
            }
          </div>

          <!-- Custom Color Input -->
          <div class="custom-color-input">
            <label class="custom-color-label">Or choose custom color:</label>
            <input type="color" [formControl]="categoryColorControl" class="color-input" />
            <span class="color-value">{{ categoryColorControl.value }}</span>
          </div>
        </div>

        <!-- Preview -->
        <div class="form-field">
          <label class="field-label">
            <ion-icon name="eye-outline"></ion-icon>
            Preview
          </label>
          <div class="category-preview">
            <ion-chip class="preview-chip" [style.--chip-color]="categoryColorControl.value">
              <ion-icon name="pricetag-outline"></ion-icon>
              <ion-label>{{ categoryNameControl.value || 'Category Name' }}</ion-label>
            </ion-chip>
          </div>
        </div>

        <!-- Actions -->
        <div class="modal-actions">
          <ion-button
            expand="block"
            (click)="createCategory()"
            [disabled]="categoryNameControl.invalid"
            class="create-btn"
          >
            <ion-icon slot="start" name="add-outline"></ion-icon>
            Create Category
          </ion-button>
          <ion-button
            expand="block"
            fill="outline"
            (click)="closeCategoryModal()"
            class="cancel-btn"
          >
            Cancel
          </ion-button>
        </div>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>
